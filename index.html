<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>To-Do List | Deep Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #ffffff; --text: #0f172a; --accent: #4f46e5; --secondary: #64748b;
            --card: #f8fafc; --border: #e2e8f0; --success: #10b981; --danger: #ef4444; 
            --warning: #f59e0b; --h0: #f1f5f9; --h4: #4f46e5;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --text: #f1f5f9; --card: #1e293b; --border: #334155; --h0: #334155;
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; transition: 0.2s; }
        .container { width: 100%; max-width: 850px; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .nav-switch { display: flex; background: var(--card); padding: 4px; border-radius: 10px; border: 1px solid var(--border); }
        .nav-btn { padding: 6px 16px; border: none; border-radius: 7px; cursor: pointer; font-weight: 600; font-size: 0.8rem; background: transparent; color: var(--secondary); }
        .nav-btn.active { background: var(--bg); color: var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .score-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px; }
        .score-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .score-v { font-size: 1.2rem; font-weight: 800; color: var(--accent); display: block; }
        .score-l { font-size: 0.55rem; color: var(--secondary); text-transform: uppercase; font-weight: 700; }

        .chart-card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-label { font-size: 0.7rem; font-weight: 800; color: var(--secondary); text-transform: uppercase; }

        .month-select { padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.75rem; font-weight: 600; }

        .dot-grid { display: grid; grid-template-rows: repeat(7, 10px); grid-auto-flow: column; gap: 3px; }
        .dot { width: 10px; height: 10px; border-radius: 2px; background: var(--h0); }

        .habit-card { background: var(--card); border: 1px solid var(--border); padding: 18px; border-radius: 16px; margin-bottom: 15px; border-left: 5px solid var(--border); }
        .subject-badge { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: inline-block; }
        
        .controls { display: flex; gap: 12px; align-items: center; }
        .num-input { width: 50px; padding: 6px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); text-align: center; font-size: 0.8rem; font-weight: 600; }

        .input-bar { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; background: var(--card); padding: 15px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px; }
        .input-bar input, .input-bar select { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.85rem; }
        .add-btn { background: var(--accent); color: white; border: none; border-radius: 8px; width: 40px; cursor: pointer; font-weight: bold; }

        .edit-panel { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border); gap: 10px; align-items: center; }
        .edit-panel.active { display: flex; }

        .cb { position: relative; width: 28px; height: 28px; cursor: pointer; }
        .cb input { opacity: 0; width: 0; height: 0; }
        .ck { position: absolute; top: 0; left: 0; height: 28px; width: 28px; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; }
        .cb input:checked ~ .ck { background: var(--success); border-color: var(--success); }
        .cb.yest input:checked ~ .ck { background: var(--warning); border-color: var(--warning); }
        .ck:after { content: ""; position: absolute; display: none; left: 9px; top: 4px; width: 6px; height: 12px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .cb input:checked ~ .ck:after { display: block; }

        .hidden { display: none !important; }
        @media (max-width: 600px) { .input-bar { grid-template-columns: 1fr; } .score-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 style="margin:0; font-weight: 800;">To-Do List</h1>
        <div class="nav-switch">
            <button class="nav-btn active" onclick="showTab('tasks', this)">Tasks</button>
            <button class="nav-btn" onclick="showTab('stats', this)">Stats</button>
        </div>
        <button onclick="toggleTheme()" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üåì</button>
    </header>

    <div class="score-grid">
        <div class="score-card"><span class="score-v" id="score-day">0%</span><span class="score-l">Today</span></div>
        <div class="score-card"><span class="score-v" id="score-qs">0</span><span class="score-l">Total Qs</span></div>
        <div class="score-card"><span class="score-v" id="score-hrs">0</span><span class="score-l">Total Hours</span></div>
        <div class="score-card"><span class="score-v" id="score-streak">0</span><span class="score-l">Streak</span></div>
    </div>

    <!-- TASKS -->
    <div id="tab-tasks">
        <div class="input-bar">
            <input type="text" id="in-name" placeholder="New Goal...">
            <select id="in-cat"><option>Study</option><option>Q Practice</option><option>Health</option><option>Personal</option></select>
            <select id="in-sub"><option>Physics</option><option>Chemistry</option><option>Math</option><option>Other</option></select>
            <select id="in-goal"><option value="7">7x/wk</option><option value="5">5x/wk</option><option value="3">3x/wk</option></select>
            <button class="add-btn" onclick="addHabit()">+</button>
        </div>
        <div id="list"></div>
    </div>

    <!-- STATS -->
    <div id="tab-stats" class="hidden">
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-label">Yearly Consistency Map</span>
            </div>
            <div id="dot-grid" class="dot-grid"></div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-label">Data Filter</span>
                <select id="month-filter" class="month-select" onchange="renderCharts()"></select>
            </div>
            <p style="font-size: 0.65rem; color: var(--secondary); margin: 0;">Select a month to filter all charts below.</p>
        </div>

        <div class="chart-card"><span class="chart-label">Monthly Completion (Day-by-Day)</span><canvas id="chart-monthly"></canvas></div>
        <div class="chart-card"><span class="chart-label">Weekly View (Current)</span><canvas id="chart-weekly"></canvas></div>
        <div class="chart-card"><span class="chart-label">Monthly Subject Hours</span><canvas id="chart-time"></canvas></div>
        <div class="chart-card"><span class="chart-label">Monthly Subject Questions</span><canvas id="chart-qs"></canvas></div>
    </div>
</div>

<script>
    let habits = JSON.parse(localStorage.getItem('todo_v27')) || [];
    const colors = { Physics: '#3b82f6', Chemistry: '#10b981', Math: '#f43f5e', Other: '#64748b' };

    function save() { localStorage.setItem('todo_v27', JSON.stringify(habits)); render(); }

    function populateMonthFilter() {
        const select = document.getElementById('month-filter');
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const now = new Date();
        select.innerHTML = '';
        for (let i = 0; i < 12; i++) {
            let opt = document.createElement('option');
            opt.value = i;
            opt.innerText = months[i];
            if (i === now.getMonth()) opt.selected = true;
            select.appendChild(opt);
        }
    }

    function addHabit() {
        const name = document.getElementById('in-name').value;
        if (!name) return;
        habits.push({
            id: 'h' + Date.now(),
            name,
            category: document.getElementById('in-cat').value,
            subject: document.getElementById('in-sub').value,
            goal: parseInt(document.getElementById('in-goal').value),
            completions: [], timeLogs: {}, qLogs: {}
        });
        document.getElementById('in-name').value = '';
        save();
    }

    function render() {
        const list = document.getElementById('list');
        const today = new Date().toISOString().split('T')[0];
        const yest = new Date(); yest.setDate(yest.getDate() - 1);
        const yestStr = yest.toISOString().split('T')[0];

        list.innerHTML = habits.map(h => {
            const subCol = colors[h.subject] || colors.Other;
            return `
            <div class="habit-card" style="border-left-color: ${subCol}">
                <div class="habit-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span class="subject-badge" style="color:${subCol}">${h.subject}</span>
                        <h3 style="margin:0">${h.name}</h3>
                    </div>
                    <div class="controls">
                        <div style="text-align:center"><span class="score-l">HRS</span><br>
                            <input type="number" class="num-input" value="${h.timeLogs[today] || 0}" onchange="logVal('${h.id}', 'time', this.value)">
                        </div>
                        ${h.category === 'Q Practice' ? `
                        <div style="text-align:center"><span class="score-l">QS</span><br>
                            <input type="number" class="num-input" value="${h.qLogs[today] || 0}" onchange="logVal('${h.id}', 'q', this.value)">
                        </div>` : ''}
                        <div style="text-align:center"><span class="score-l">YEST</span><br>
                            <label class="cb yest"><input type="checkbox" ${h.completions.includes(yestStr)?'checked':''} onchange="toggle('${h.id}','${yestStr}')"><span class="ck"></span></label>
                        </div>
                        <div style="text-align:center"><span class="score-l">TODAY</span><br>
                            <label class="cb"><input type="checkbox" ${h.completions.includes(today)?'checked':''} onchange="toggle('${h.id}','${today}')"><span class="ck"></span></label>
                        </div>
                    </div>
                </div>
                <div id="edit-${h.id}" class="edit-panel">
                    <input type="text" value="${h.name}" onchange="editH('${h.id}','name',this.value)">
                    <select onchange="editH('${h.id}','subject',this.value)">
                        <option ${h.subject==='Physics'?'selected':''}>Physics</option>
                        <option ${h.subject==='Chemistry'?'selected':''}>Chemistry</option>
                        <option ${h.subject==='Math'?'selected':''}>Math</option>
                        <option ${h.subject==='Other'?'selected':''}>Other</option>
                    </select>
                    <button onclick="delH('${h.id}')" style="background:var(--danger); color:white; border:none; border-radius:6px; padding:7px 12px; cursor:pointer;">Delete</button>
                </div>
                <button onclick="document.getElementById('edit-${h.id}').classList.toggle('active')" style="background:none; border:none; color:var(--secondary); font-size:0.6rem; cursor:pointer; margin-top:10px; padding:0;">‚öôÔ∏è Edit Habit</button>
            </div>`;
        }).join('');
        updateScores();
    }

    function renderCharts() {
        const selectedMonth = parseInt(document.getElementById('month-filter').value);
        const now = new Date();
        const year = now.getFullYear();

        // 1. Yearly Map
        const grid = document.getElementById('dot-grid'); grid.innerHTML = '';
        for (let i = 0; i < 364; i++) {
            const d = new Date(year, 0, 1); d.setDate(d.getDate() + i);
            const count = habits.filter(h => h.completions.includes(d.toISOString().split('T')[0])).length;
            grid.innerHTML += `<div class="dot" style="background:${count > 0 ? 'var(--h4)' : 'var(--h0)'}; opacity:${count>0 ? 0.3+(count*0.15) : 1}"></div>`;
        }

        // 2. Monthly Detail Line Chart (Days of Selected Month)
        const daysInMonth = new Date(year, selectedMonth + 1, 0).getDate();
        const mLabels = Array.from({length: daysInMonth}, (_, i) => i + 1);
        const mData = mLabels.map(day => {
            let ds = new Date(year, selectedMonth, day).toISOString().split('T')[0];
            return habits.filter(h => h.completions.includes(ds)).length;
        });
        drawChart('chart-monthly', 'line', mLabels, mData, '#8b5cf6');

        // 3. Weekly (Standard)
        const weeklyLabels = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate() - (6 - i)); return d.toLocaleDateString('en-US', { weekday: 'short' }); });
        const weeklyData = weeklyLabels.map((_, i) => {
            const d = new Date(); d.setDate(d.getDate() - (6 - i));
            return habits.filter(h => h.completions.includes(d.toISOString().split('T')[0])).length;
        });
        drawChart('chart-weekly', 'line', weeklyLabels, weeklyData, '#4f46e5');

        // 4. Monthly Subject Stats
        const subHours = { Physics: 0, Chemistry: 0, Math: 0, Other: 0 };
        const subQs = { Physics: 0, Chemistry: 0, Math: 0, Other: 0 };
        
        habits.forEach(h => {
            Object.keys(h.timeLogs).forEach(date => {
                let d = new Date(date);
                if (d.getMonth() === selectedMonth && d.getFullYear() === year) subHours[h.subject] += h.timeLogs[date];
            });
            Object.keys(h.qLogs).forEach(date => {
                let d = new Date(date);
                if (d.getMonth() === selectedMonth && d.getFullYear() === year) subQs[h.subject] += h.qLogs[date];
            });
        });

        drawChart('chart-time', 'bar', Object.keys(subHours), Object.values(subHours), '#3b82f6');
        drawChart('chart-qs', 'bar', Object.keys(subQs), Object.values(subQs), '#10b981');
    }

    function drawChart(id, type, labels, data, color) {
        Chart.getChart(id)?.destroy();
        new Chart(document.getElementById(id), {
            type,
            data: { labels, datasets: [{ data, borderColor: color, backgroundColor: color + '20', fill: true, tension: 0.4, borderRadius: 5 }] },
            options: { plugins: { legend: false }, scales: { y: { beginAtZero: true } } }
        });
    }

    function logVal(id, type, val) {
        const h = habits.find(x => x.id === id);
        const ds = new Date().toISOString().split('T')[0];
        const n = parseFloat(val) || 0;
        if (type === 'time') h.timeLogs[ds] = n; else h.qLogs[ds] = n;
        if (n > 0 && !h.completions.includes(ds)) h.completions.push(ds);
        save();
    }

    function toggle(id, ds) {
        const h = habits.find(x => x.id === id);
        const idx = h.completions.indexOf(ds);
        idx > -1 ? h.completions.splice(idx, 1) : h.completions.push(ds);
        save();
    }

    function updateScores() {
        const today = new Date().toISOString().split('T')[0];
        const done = habits.filter(h => h.completions.includes(today)).length;
        let tQ = 0, tH = 0;
        habits.forEach(h => {
            tQ += Object.values(h.qLogs).reduce((a,b)=>a+b, 0);
            tH += Object.values(h.timeLogs).reduce((a,b)=>a+b, 0);
        });
        document.getElementById('score-day').innerText = habits.length ? Math.round(done/habits.length*100) + '%' : '0%';
        document.getElementById('score-qs').innerText = tQ;
        document.getElementById('score-hrs').innerText = tH.toFixed(1);
        document.getElementById('score-streak').innerText = calculateStreak();
    }

    function calculateStreak() {
        let s = 0; let d = new Date();
        while(habits.some(h => h.completions.includes(d.toISOString().split('T')[0]))) { s++; d.setDate(d.getDate()-1); }
        return s;
    }

    function showTab(t, btn) {
        document.getElementById('tab-tasks').classList.toggle('hidden', t !== 'tasks');
        document.getElementById('tab-stats').classList.toggle('hidden', t !== 'stats');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (t === 'stats') renderCharts();
    }

    function editH(id, k, v) { habits.find(x => x.id === id)[k] = v; save(); }
    function delH(id) { if(confirm('Delete permanently?')) { habits = habits.filter(x => x.id !== id); save(); } }
    function toggleTheme() {
        const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('todo_theme', t);
    }

    if (localStorage.getItem('todo_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    populateMonthFilter();
    render();
</script>
</body>
</html>
